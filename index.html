<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretariat Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --success: #06ffa5;
            --warning: #ffb700;
            --danger: #ff006e;
            --dark: #0f0f1e;
            --darker: #080814;
            --light: #f8f9fa;
            --gray: #6c757d;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--darker);
            color: var(--light);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(76, 201, 240, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(6, 255, 165, 0.03) 0%, transparent 70%);
        }

        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(67, 97, 238, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(67, 97, 238, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            opacity: 0.15;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .connect-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .connect-btn:hover {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .status-indicator.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .filter-select {
            width: 100%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 12px 15px;
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.2);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray);
        }

        .card-icon {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--light), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .card-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            height: 400px;
            position: relative;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--light);
            text-align: center;
        }

        .data-table-container {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 15, 30, 0.9);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .notification-close {
            cursor: pointer;
            color: var(--light);
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(67, 97, 238, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.5;
        }

        .refresh-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
        }

        .refresh-btn i {
            font-size: 1rem;
        }

        .config-section {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .config-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .config-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .config-input {
            flex: 1;
            min-width: 250px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 12px 15px;
            border-radius: 10px;
            outline: none;
            backdrop-filter: blur(10px);
        }

        .config-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.2);
        }

        .config-btn {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border: none;
            color: var(--dark);
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .config-form {
                flex-direction: column;
            }
            
            .config-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    <div class="grid-bg"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-network"></i>
                <h1>Secretariat Analytics</h1>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
                <button class="connect-btn" id="connectBtn">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Connect to Google Sheets</span>
                </button>
            </div>
        </header>

        <div class="config-section">
            <div class="config-title">Google Sheets Configuration</div>
            <div class="config-form">
                <input type="text" class="config-input" id="spreadsheetId" placeholder="Enter Google Sheet ID">
                <button class="config-btn" id="saveConfigBtn">Save Configuration</button>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label class="filter-label" for="mandalFilter">Mandal</label>
                <select class="filter-select" id="mandalFilter">
                    <option value="">All Mandals</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="secretariatFilter">Secretariat</label>
                <select class="filter-select" id="secretariatFilter">
                    <option value="">All Secretariats</option>
                </select>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Secretariats</div>
                    <div class="card-icon"><i class="fas fa-building"></i></div>
                </div>
                <div class="card-value" id="totalSecretariats">0</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>12% from last month</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Families</div>
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                </div>
                <div class="card-value" id="totalFamilies">0</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>8% from last month</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Adopted</div>
                    <div class="card-icon"><i class="fas fa-heart"></i></div>
                </div>
                <div class="card-value" id="totalAdopted">0</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>15% from last month</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Coverage Rate</div>
                    <div class="card-icon"><i class="fas fa-percentage"></i></div>
                </div>
                <div class="card-value" id="coverageRate">0%</div>
                <div class="progress-bar">
                    <div class="progress" id="coverageProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="analytics">Analytics</div>
            <div class="tab" data-tab="data">Data Table</div>
            <div class="tab" data-tab="comparison">Comparison</div>
        </div>

        <div class="tab-content active" id="analytics">
            <div class="chart-container">
                <div class="chart-title">Secretariat Performance Overview</div>
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Adoption Rate by Mandal</div>
                <canvas id="adoptionChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="data">
            <div class="data-table-container">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Secretariat Name</th>
                            <th>Mandal Name</th>
                            <th>Total Families</th>
                            <th>Total Family Members</th>
                            <th>Total Adopted</th>
                            <th>Bangaru Kutumbam Yet to Adopt</th>
                            <th>Margadarsi Mobilized</th>
                            <th>Total Secretariats</th>
                            <th>Covered Secretariats</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 30px;">
                                <div class="loading-spinner" id="loadingSpinner"></div>
                                <div class="empty-state" id="emptyState">
                                    <i class="fas fa-database"></i>
                                    <p>No data available. Connect to Google Sheets to fetch data.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="comparison">
            <div class="chart-container">
                <div class="chart-title">Mandal Comparison</div>
                <canvas id="comparisonChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Adoption Progress</div>
                <canvas id="progressChart"></canvas>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-icon"><i class="fas fa-info-circle"></i></div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">Notification</div>
            <div class="notification-message" id="notificationMessage">This is a notification message</div>
        </div>
        <div class="notification-close" id="notificationClose"><i class="fas fa-times"></i></div>
    </div>

    <script>
        // Sheet names
        const SECRETARIAT_SHEET = 'SecretariatData';
        const MANDAL_SHEET = 'Mandal';
        
        // Global variables
        let isConnected = false;
        let spreadsheetId = '';
        let secretariatData = [];
        let mandalData = [];
        let mandalMap = {};
        let filteredData = [];
        let performanceChart, adoptionChart, comparisonChart, progressChart;
        
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const spreadsheetIdInput = document.getElementById('spreadsheetId');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationClose = document.getElementById('notificationClose');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const emptyState = document.getElementById('emptyState');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const mandalFilter = document.getElementById('mandalFilter');
        const secretariatFilter = document.getElementById('secretariatFilter');
        const tableBody = document.getElementById('tableBody');
        
        // Initialize the dashboard
        function init() {
            setupEventListeners();
            initCharts();
            loadSavedConfig();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            connectBtn.addEventListener('click', toggleConnection);
            refreshBtn.addEventListener('click', refreshData);
            saveConfigBtn.addEventListener('click', saveConfig);
            notificationClose.addEventListener('click', hideNotification);
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            mandalFilter.addEventListener('change', applyFilters);
            secretariatFilter.addEventListener('change', applyFilters);
        }
        
        // Load saved configuration from localStorage
        function loadSavedConfig() {
            const savedId = localStorage.getItem('spreadsheetId');
            if (savedId) {
                spreadsheetId = savedId;
                spreadsheetIdInput.value = savedId;
            }
        }
        
        // Save configuration to localStorage
        function saveConfig() {
            const id = spreadsheetIdInput.value.trim();
            if (!id) {
                showNotification('Configuration Error', 'Please enter a valid Google Sheet ID.');
                return;
            }
            
            spreadsheetId = id;
            localStorage.setItem('spreadsheetId', id);
            showNotification('Configuration Saved', 'Google Sheet ID has been saved successfully.');
        }
        
        // Toggle connection to Google Sheets
        function toggleConnection() {
            if (!isConnected) {
                connectToGoogleSheets();
            } else {
                disconnectFromGoogleSheets();
            }
        }
        
        // Connect to Google Sheets and fetch data
        async function connectToGoogleSheets() {
            if (!spreadsheetId) {
                showNotification('Configuration Required', 'Please enter and save your Google Sheet ID first.');
                return;
            }
            
            statusText.textContent = 'Connecting...';
            
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            emptyState.style.display = 'none';
            
            try {
                // Fetch Mandal data
                const mandalResponse = await fetchGoogleSheetData(MANDAL_SHEET);
                mandalData = parseCSVData(mandalResponse);
                
                // Create Mandal map for ID to name mapping
                mandalMap = {};
                mandalData.forEach(mandal => {
                    mandalMap[mandal.ID] = mandal.MandalName;
                });
                
                // Fetch Secretariat data
                const secretariatResponse = await fetchGoogleSheetData(SECRETARIAT_SHEET);
                secretariatData = parseCSVData(secretariatResponse);
                
                // Process secretariat data to add MandalName
                processSecretariatData();
                
                // Update UI
                isConnected = true;
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected';
                
                // Populate filters
                populateFilters();
                
                // Apply initial filters
                applyFilters();
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                // Show notification
                showNotification('Connection Successful', 'Successfully connected to Google Sheets and fetched data.');
            } catch (error) {
                console.error('Error connecting to Google Sheets:', error);
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                emptyState.style.display = 'block';
                
                // Show error notification
                showNotification('Connection Failed', 'Failed to connect to Google Sheets. Please check your Sheet ID and ensure the sheet is public.');
            }
        }
        
        // Fetch data from Google Sheet as CSV
        async function fetchGoogleSheetData(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            return await response.text();
        }
        
        // Parse CSV data
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                return [];
            }
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const item = {};
                
                for (let j = 0; j < headers.length; j++) {
                    if (j < values.length) {
                        item[headers[j]] = values[j] || '';
                    }
                }
                
                data.push(item);
            }
            
            return data;
        }
        
        // Parse a CSV line, handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            
            result.push(currentValue);
            return result;
        }
        
        // Process secretariat data to add MandalName
        function processSecretariatData() {
            secretariatData.forEach(item => {
                // Get MandalName from the map using ID
                item.MandalName = mandalMap[item.ID] || 'Unknown';
                
                // Convert numeric fields to numbers
                item.TotalFamilies = parseInt(item.TotalFamilies) || 0;
                item.TotalFamilyMembers = parseInt(item.TotalFamilyMembers) || 0;
                item.TotalAdopted = parseInt(item.TotalAdopted) || 0;
                item.TotalBangaruKutumbamYetToAdopt = parseInt(item.TotalBangaruKutumbamYetToAdopt) || 0;
                item.TotalMargadarsiMobilized = parseInt(item.TotalMargadarsiMobilized) || 0;
                item.TotalSecretariats = parseInt(item.TotalSecretariats) || 0;
                item.CoveredSecretariats = parseInt(item.CoveredSecretariats) || 0;
            });
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // Clear existing options
            mandalFilter.innerHTML = '<option value="">All Mandals</option>';
            secretariatFilter.innerHTML = '<option value="">All Secretariats</option>';
            
            // Get unique Mandal names
            const uniqueMandals = [...new Set(secretariatData.map(item => item.MandalName))];
            uniqueMandals.forEach(mandal => {
                const option = document.createElement('option');
                option.value = mandal;
                option.textContent = mandal;
                mandalFilter.appendChild(option);
            });
            
            // Populate Secretariat filter
            secretariatData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.ID;
                option.textContent = item.SecretariatName;
                secretariatFilter.appendChild(option);
            });
        }
        
        // Apply filters to data
        function applyFilters() {
            const selectedMandal = mandalFilter.value;
            const selectedSecretariat = secretariatFilter.value;
            
            // Filter data based on selections
            filteredData = secretariatData.filter(item => {
                const matchesMandal = !selectedMandal || item.MandalName === selectedMandal;
                const matchesSecretariat = !selectedSecretariat || item.ID === selectedSecretariat;
                return matchesMandal && matchesSecretariat;
            });
            
            // Update dashboard with filtered data
            updateDashboard();
            updateTable();
            updateCharts();
        }
        
        // Update dashboard with data
        function updateDashboard() {
            if (!isConnected || filteredData.length === 0) return;
            
            // Calculate totals
            const totalSecretariats = filteredData.reduce((sum, item) => sum + item.TotalSecretariats, 0);
            const totalFamilies = filteredData.reduce((sum, item) => sum + item.TotalFamilies, 0);
            const totalAdopted = filteredData.reduce((sum, item) => sum + item.TotalAdopted, 0);
            const totalCovered = filteredData.reduce((sum, item) => sum + item.CoveredSecretariats, 0);
            const coverageRate = totalSecretariats > 0 ? Math.round((totalCovered / totalSecretariats) * 100) : 0;
            
            // Update dashboard cards
            document.getElementById('totalSecretariats').textContent = totalSecretariats.toLocaleString();
            document.getElementById('totalFamilies').textContent = totalFamilies.toLocaleString();
            document.getElementById('totalAdopted').textContent = totalAdopted.toLocaleString();
            document.getElementById('coverageRate').textContent = coverageRate + '%';
            document.getElementById('coverageProgress').style.width = coverageRate + '%';
        }
        
        // Update data table
        function updateTable() {
            if (!isConnected) return;
            
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 30px;">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>No data matches your filters. Try adjusting your selection.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.ID}</td>
                    <td>${item.SecretariatName}</td>
                    <td>${item.MandalName}</td>
                    <td>${item.TotalFamilies.toLocaleString()}</td>
                    <td>${item.TotalFamilyMembers.toLocaleString()}</td>
                    <td>${item.TotalAdopted.toLocaleString()}</td>
                    <td>${item.TotalBangaruKutumbamYetToAdopt.toLocaleString()}</td>
                    <td>${item.TotalMargadarsiMobilized.toLocaleString()}</td>
                    <td>${item.TotalSecretariats}</td>
                    <td>${item.CoveredSecretariats}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Switch between tabs
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Update charts when switching to analytics or comparison tab
            if (tabId === 'analytics' || tabId === 'comparison') {
                updateCharts();
            }
        }
        
        // Initialize charts
        function initCharts() {
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Total Families',
                            data: [],
                            backgroundColor: 'rgba(67, 97, 238, 0.7)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Adopted',
                            data: [],
                            backgroundColor: 'rgba(76, 201, 240, 0.7)',
                            borderColor: 'rgba(76, 201, 240, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
            
            // Adoption Chart
            const adoptionCtx = document.getElementById('adoptionChart').getContext('2d');
            adoptionChart = new Chart(adoptionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Adoption Rate',
                        data: [],
                        backgroundColor: 'rgba(6, 255, 165, 0.2)',
                        borderColor: 'rgba(6, 255, 165, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
            
            // Comparison Chart
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(comparisonCtx, {
                type: 'radar',
                data: {
                    labels: ['Total Families', 'Total Adopted', 'Bangaru Kutumbam', 'Margadarsi', 'Coverage'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#f8f9fa',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            ticks: {
                                color: '#f8f9fa',
                                backdropColor: 'transparent',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
            
            // Progress Chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Adopted', 'Yet to Adopt'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            'rgba(6, 255, 165, 0.7)',
                            'rgba(255, 255, 255, 0.1)'
                        ],
                        borderColor: [
                            'rgba(6, 255, 165, 1)',
                            'rgba(255, 255, 255, 0.2)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f8f9fa',
                                padding: 20,
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }
        
        // Update charts with data
        function updateCharts() {
            if (!isConnected || filteredData.length === 0) return;
            
            // Update Performance Chart
            const secretariatNames = filteredData.map(item => item.SecretariatName);
            const totalFamilies = filteredData.map(item => item.TotalFamilies);
            const totalAdopted = filteredData.map(item => item.TotalAdopted);
            
            performanceChart.data.labels = secretariatNames;
            performanceChart.data.datasets[0].data = totalFamilies;
            performanceChart.data.datasets[1].data = totalAdopted;
            performanceChart.update();
            
            // Update Adoption Chart
            const uniqueMandals = [...new Set(filteredData.map(item => item.MandalName))];
            const adoptionRates = uniqueMandals.map(mandal => {
                const mandalData = filteredData.filter(item => item.MandalName === mandal);
                const totalFamilies = mandalData.reduce((sum, item) => sum + item.TotalFamilies, 0);
                const totalAdopted = mandalData.reduce((sum, item) => sum + item.TotalAdopted, 0);
                return totalFamilies > 0 ? Math.round((totalAdopted / totalFamilies) * 100) : 0;
            });
            
            adoptionChart.data.labels = uniqueMandals;
            adoptionChart.data.datasets[0].data = adoptionRates;
            adoptionChart.update();
            
            // Update Comparison Chart
            const datasets = [];
            const colors = [
                'rgba(67, 97, 238, 0.5)',
                'rgba(76, 201, 240, 0.5)',
                'rgba(6, 255, 165, 0.5)',
                'rgba(255, 183, 0, 0.5)',
                'rgba(255, 0, 110, 0.5)'
            ];
            
            uniqueMandals.forEach((mandal, index) => {
                const mandalData = filteredData.filter(item => item.MandalName === mandal);
                const totalFamilies = mandalData.reduce((sum, item) => sum + item.TotalFamilies, 0);
                const totalAdopted = mandalData.reduce((sum, item) => sum + item.TotalAdopted, 0);
                const totalBangaruKutumbam = mandalData.reduce((sum, item) => sum + item.TotalBangaruKutumbamYetToAdopt, 0);
                const totalMargadarsi = mandalData.reduce((sum, item) => sum + item.TotalMargadarsiMobilized, 0);
                const totalSecretariats = mandalData.reduce((sum, item) => sum + item.TotalSecretariats, 0);
                const totalCovered = mandalData.reduce((sum, item) => sum + item.CoveredSecretariats, 0);
                const coverageRate = totalSecretariats > 0 ? Math.round((totalCovered / totalSecretariats) * 100) : 0;
                
                datasets.push({
                    label: mandal,
                    data: [
                        totalFamilies / 100,
                        totalAdopted / 100,
                        totalBangaruKutumbam / 100,
                        totalMargadarsi / 100,
                        coverageRate
                    ],
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.5', '1'),
                    borderWidth: 1,
                    pointBackgroundColor: colors[index % colors.length].replace('0.5', '1')
                });
            });
            
            comparisonChart.data.datasets = datasets;
            comparisonChart.update();
            
            // Update Progress Chart
            const totalAdoptedSum = filteredData.reduce((sum, item) => sum + item.TotalAdopted, 0);
            const totalFamiliesSum = filteredData.reduce((sum, item) => sum + item.TotalFamilies, 0);
            const yetToAdopt = totalFamiliesSum - totalAdoptedSum;
            const adoptionPercentage = totalFamiliesSum > 0 ? Math.round((totalAdoptedSum / totalFamiliesSum) * 100) : 0;
            
            progressChart.data.datasets[0].data = [adoptionPercentage, 100 - adoptionPercentage];
            progressChart.update();
        }
        
        // Refresh data from Google Sheets
        function refreshData() {
            if (!isConnected) {
                showNotification('Not Connected', 'Please connect to Google Sheets first.');
                return;
            }
            
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Simulate refresh delay
            setTimeout(() => {
                connectToGoogleSheets();
            }, 1000);
        }
        
        // Disconnect from Google Sheets
        function disconnectFromGoogleSheets() {
            isConnected = false;
            statusIndicator.classList.remove('connected');
            statusText.textContent = 'Connect to Google Sheets';
            
            // Show notification
            showNotification('Disconnected', 'Disconnected from Google Sheets.');
            
            // Reset dashboard
            resetDashboard();
        }
        
        // Reset dashboard to initial state
        function resetDashboard() {
            document.getElementById('totalSecretariats').textContent = '0';
            document.getElementById('totalFamilies').textContent = '0';
            document.getElementById('totalAdopted').textContent = '0';
            document.getElementById('coverageRate').textContent = '0%';
            document.getElementById('coverageProgress').style.width = '0%';
            
            // Clear filters
            mandalFilter.innerHTML = '<option value="">All Mandals</option>';
            secretariatFilter.innerHTML = '<option value="">All Secretariats</option>';
            
            // Clear table
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 30px;">
                        <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                        <div class="empty-state" id="emptyState">
                            <i class="fas fa-database"></i>
                            <p>No data available. Connect to Google Sheets to fetch data.</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Reset charts
            if (performanceChart) performanceChart.destroy();
            if (adoptionChart) adoptionChart.destroy();
            if (comparisonChart) comparisonChart.destroy();
            if (progressChart) progressChart.destroy();
            
            // Reinitialize empty charts
            initCharts();
        }
        
        // Show notification
        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notification.classList.add('show');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        // Hide notification
        function hideNotification() {
            notification.classList.remove('show');
        }
        
        // Initialize the dashboard when the page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
