<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandal Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mandal Data Dashboard</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label for="constituency">Constituency:</label>
                <select id="constituency">
                    <option value="">All Constituencies</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="mandal">Mandal:</label>
                <select id="mandal">
                    <option value="">All Mandals</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search">Search:</label>
                <input type="text" id="search" placeholder="Search mandals...">
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-label">Total Families</div>
                <div class="metric-value" id="total-families">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Members</div>
                <div class="metric-value" id="total-members">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Adopted</div>
                <div class="metric-value" id="total-adopted">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Margadarsi Mobilized</div>
                <div class="metric-value" id="total-margadarsi">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Secretariats Covered</div>
                <div class="metric-value" id="coverage-rate">0%</div>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart-container">
                <canvas id="familiesChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="coverageChart"></canvas>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading data from Google Sheets...</div>
        <table id="data-table">
            <thead>
                <tr>
                    <th>Mandal</th>
                    <th>Families</th>
                    <th>Members</th>
                    <th>Adopted</th>
                    <th>Margadarsi</th>
                    <th>Total Secretariats</th>
                    <th>Covered</th>
                    <th>Coverage %</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Google Sheets URL - Replace with your published sheet URL
        // Make sure your sheet is published to the web (File > Share > Publish to web)
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsnv-98J5oXEody7EA_z2FLoc71K4VmXMC5LwSysYS5apoCZ-qX4dOrDYZWjQBHZTT9XKzAtNSymw_/pub?output=csv';
        
        let allData = [];
        let filteredData = [];
        let familiesChart, coverageChart;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Setup event listeners
            document.getElementById('constituency').addEventListener('change', filterData);
            document.getElementById('mandal').addEventListener('change', filterData);
            document.getElementById('search').addEventListener('input', filterData);
        });
        
        function loadData() {
            Papa.parse(sheetUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    allData = results.data.map(row => {
                        // Clean and parse numeric values
                        return {
                            MandalName: row.MandalName || '',
                            TotalFamilies: parseInt(row.TotalFamilies) || 0,
                            TotalFamilyMembers: parseInt(row.TotalFamilyMembers) || 0,
                            TotalAdopted: parseInt(row.TotalAdopted) || 0,
                            TotalMargadarsiMobilized: parseInt(row.TotalMargadarsiMobilized) || 0,
                            TotalSecretariats: parseInt(row.TotalSecretariats) || 0,
                            CoveredSecretariats: parseInt(row.CoveredSecretariats) || 0,
                            // Extract constituency from mandal name if not in data
                            Constituency: row.Constituency || extractConstituency(row.MandalName)
                        };
                    });
                    
                    // Initialize filters
                    initFilters();
                    // Process initial data
                    filterData();
                    // Hide loading
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(error) {
                    console.error('Error loading data:', error);
                    document.getElementById('loading').textContent = 'Error loading data. Please check the sheet URL.';
                }
            });
        }
        
        function extractConstituency(mandalName) {
            // Simple extraction - modify based on your naming pattern
            if (mandalName.includes('(R)')) return 'Rural';
            if (mandalName.includes('(U)')) return 'Urban';
            return 'General';
        }
        
        function initFilters() {
            const constituencySelect = document.getElementById('constituency');
            const mandalSelect = document.getElementById('mandal');
            
            // Get unique constituencies
            const constituencies = [...new Set(allData.map(item => item.Constituency))];
            constituencies.forEach(cons => {
                const option = document.createElement('option');
                option.value = cons;
                option.textContent = cons;
                constituencySelect.appendChild(option);
            });
            
            // Get all mandals
            allData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.MandalName;
                option.textContent = item.MandalName;
                mandalSelect.appendChild(option);
            });
        }
        
        function filterData() {
            const selectedConstituency = document.getElementById('constituency').value;
            const selectedMandal = document.getElementById('mandal').value;
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            filteredData = allData.filter(item => {
                return (selectedConstituency === '' || item.Constituency === selectedConstituency) &&
                       (selectedMandal === '' || item.MandalName === selectedMandal) &&
                       (searchTerm === '' || item.MandalName.toLowerCase().includes(searchTerm));
            });
            
            updateMetrics();
            updateTable();
            updateCharts();
        }
        
        function updateMetrics() {
            const totalFamilies = filteredData.reduce((sum, item) => sum + item.TotalFamilies, 0);
            const totalMembers = filteredData.reduce((sum, item) => sum + item.TotalFamilyMembers, 0);
            const totalAdopted = filteredData.reduce((sum, item) => sum + item.TotalAdopted, 0);
            const totalMargadarsi = filteredData.reduce((sum, item) => sum + item.TotalMargadarsiMobilized, 0);
            const totalSecretariats = filteredData.reduce((sum, item) => sum + item.TotalSecretariats, 0);
            const totalCovered = filteredData.reduce((sum, item) => sum + item.CoveredSecretariats, 0);
            const coverageRate = totalSecretariats > 0 ? Math.round((totalCovered / totalSecretariats) * 100) : 0;
            
            document.getElementById('total-families').textContent = totalFamilies.toLocaleString();
            document.getElementById('total-members').textContent = totalMembers.toLocaleString();
            document.getElementById('total-adopted').textContent = totalAdopted.toLocaleString();
            document.getElementById('total-margadarsi').textContent = totalMargadarsi.toLocaleString();
            document.getElementById('coverage-rate').textContent = `${coverageRate}%`;
        }
        
        function updateTable() {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';
            
            filteredData.forEach(item => {
                const coverageRate = item.TotalSecretariats > 0 
                    ? Math.round((item.CoveredSecretariats / item.TotalSecretariats) * 100) 
                    : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.MandalName}</td>
                    <td>${item.TotalFamilies.toLocaleString()}</td>
                    <td>${item.TotalFamilyMembers.toLocaleString()}</td>
                    <td>${item.TotalAdopted.toLocaleString()}</td>
                    <td>${item.TotalMargadarsiMobilized.toLocaleString()}</td>
                    <td>${item.TotalSecretariats.toLocaleString()}</td>
                    <td>${item.CoveredSecretariats.toLocaleString()}</td>
                    <td>${coverageRate}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateCharts() {
            // Sort data for better chart display
            const sortedData = [...filteredData].sort((a, b) => b.TotalFamilies - a.TotalFamilies);
            const mandals = sortedData.map(item => item.MandalName);
            const families = sortedData.map(item => item.TotalFamilies);
            const coverage = sortedData.map(item => {
                return item.TotalSecretariats > 0 
                    ? Math.round((item.CoveredSecretariats / item.TotalSecretariats) * 100)
                    : 0;
            });
            
            // Families Chart
            const familiesCtx = document.getElementById('familiesChart').getContext('2d');
            if (familiesChart) familiesChart.destroy();
            familiesChart = new Chart(familiesCtx, {
                type: 'bar',
                data: {
                    labels: mandals,
                    datasets: [{
                        label: 'Number of Families',
                        data: families,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Families by Mandal'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Coverage Chart
            const coverageCtx = document.getElementById('coverageChart').getContext('2d');
            if (coverageChart) coverageChart.destroy();
            coverageChart = new Chart(coverageCtx, {
                type: 'bar',
                data: {
                    labels: mandals,
                    datasets: [{
                        label: 'Secretariat Coverage (%)',
                        data: coverage,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Secretariat Coverage by Mandal'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
